- name: Check if autofs has been disabled on slurm nodes
  command: /usr/bin/systemctl status autofs
  when: cvmfsnfsclient is defined
  ignore_errors: yes 
  changed_when: false
  register: service_status
  failed_when: >
    ("active (running)" in service_status.stdout) or
    ("enabled; vendor preset" in service_status.stdout)
  tags: check_services\

- name: Check if generic services  are running
  command: /usr/bin/systemctl status {{ gservice_item }}
  with_items:
    - fail2ban
    - firewalld
    - sshd
    - rsyslog
    - telegraf
    - metricbeat
    - filebeat
  loop_control:
    loop_var: gservice_item
  ignore_errors: yes 
  changed_when: false
  register: service_status
  failed_when: >
    ("active (running)" not in service_status.stdout) or
    ("enabled; vendor preset" not in service_status.stdout)
  tags: check_services

- name: Check if services on main node are running usegalaxy.no
  command: /usr/bin/systemctl status {{ mservice_item }}
  when: mainnode is defined
  with_items:
    - nga-master
    - nga-runner@001
    - nga-runner@002
    - galaxy
    - nfs-server
    - autofs
    - nginx
    - docker
  loop_control:
    loop_var: mservice_item
  ignore_errors: yes 
  changed_when: false
  register: service_status
  failed_when: >
    ("active (running)" not in service_status.stdout) or
    ("enabled; vendor preset" not in service_status.stdout)
  tags: check_services

- name: Check if  services on slurm nodes are running
  command: /usr/bin/systemctl status {{ gservice_item }}
  when: slurmnode is defined
  with_items:
    - slurmd
  loop_control:
    loop_var: gservice_item
  ignore_errors: yes 
  changed_when: false
  register: service_status
  failed_when: >
    ("active (running)" not in service_status.stdout) or
    ("enabled; vendor preset" not in service_status.stdout)
  tags: check_services
